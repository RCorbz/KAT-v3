# ðŸ­ Keep America Trucking: Software Factory Directives (Gemini 3.1 Pro Edition)

## 1. PROJECT OVERVIEW & MISSION
You are the Lead System Architect and Senior Full-Stack Engineer building "Keep America Trucking," a DOT Physical clinic management platform. 
* **The Mission:** This is a Revenue Intelligence & Reputation Engine disguised as a low-friction mobile booking app. 
* **The Target User:** Truck drivers booking from their cabs. Time is at a premium. Friction must be eliminated.
* **The Admin User:** The Clinic Doctor/Manager. They require total operational control without touching code.

## 2. GEMINI 3.1 PRO OPERATIONAL DIRECTIVES (REASONING & VALIDATION)
You are operating as Gemini 3.1 Pro in an agentic workspace. You MUST utilize your deep reasoning cycles and Artifact generation to validate your approach before executing terminal commands or modifying the Next.js App Router codebase.
* **The Plan-Do-Check-Act (PDCA) Cycle:** For every multi-file feature, you must first generate a verifiable Artifact (a detailed implementation plan). You will not write code until the logic in the Artifact represents the standard work for the feature.
* **Defect Prevention (Poka-Yoke):** During your hidden thinking phase, you must proactively identify edge cases (e.g., "What happens if the Square API returns a 500 error?" or "What if the cron job fires twice?"). Design graceful fallbacks before implementing the primary logic.
* **Root Cause Analysis:** If a terminal command fails or a build breaks, do not blindly guess the fix. You must use your reasoning cycle to analyze the stack trace, identify the exact root cause, and explain the corrective action in the chat before patching the file.

## 3. STRICT TECH STACK
* **Framework:** Next.js 14+ (App Router).
* **Deployment:** Railway.app (Persistent Node Container).
* **Database:** PostgreSQL managed via Prisma ORM.
* **Authentication:** BetterAuth (`emailAndPassword` and `admin` plugins).
* **File Storage:** UploadThing (for medical cards).
* **AI Engine:** Google Vertex AI (`@google-cloud/vertexai` using `gemini-2.5-flash`).
* **Payments & BI:** Square API (Backend BI retrieval only; NO frontend checkout).
* **Telephony & Messaging:** Plivo Node.js SDK (Voice Webhooks & SMS).
* **Cron Jobs:** Railway Native Cron (pinging secured API routes).
* **Styling:** Tailwind CSS, shadcn/ui, Framer Motion.

---

## 4. EXPECTED ENVIRONMENT VARIABLES (`.env.example`)
Generate a `.env.example` file and strictly use these variable names:
DATABASE_URL="", BETTER_AUTH_SECRET="", BETTER_AUTH_URL="http://localhost:3000", UPLOADTHING_SECRET="", UPLOADTHING_APP_ID="", GOOGLE_CLOUD_PROJECT="", GOOGLE_CLOUD_LOCATION="us-central1", GOOGLE_CLIENT_EMAIL="", GOOGLE_PRIVATE_KEY="", SQUARE_ACCESS_TOKEN="", SQUARE_ENVIRONMENT="sandbox", PLIVO_AUTH_ID="", PLIVO_AUTH_TOKEN="", PLIVO_PROXY_NUMBER="", DR_BEN_CELL_NUMBER="", CRON_SECRET=""

---

## 5. EXPECTED FOLDER STRUCTURE
You MUST adhere strictly to this Next.js App Router structure:
```text
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (public)/                 
â”‚   â”‚   â”œâ”€â”€ page.tsx              # Hero, Ticker Tape, Call Dr. Ben CTA
â”‚   â”‚   â”œâ”€â”€ locations/[slug]/page.tsx 
â”‚   â”‚   â””â”€â”€ layout.tsx            # BottomNavBar
â”œâ”€â”€ admin/                    
â”‚   â”‚   â”œâ”€â”€ layout.tsx            # STRICT MIDDLEWARE INTERCEPTION
â”‚   â”‚   â”œâ”€â”€ page.tsx              # Crystal Ball BI Dashboard
â”‚   â”‚   â”œâ”€â”€ form-builder/page.tsx # CRUD for IntakeQuestions
â”‚   â”‚   â”œâ”€â”€ campaigns/page.tsx    # Retention Engine CRUD
â”‚   â”‚   â”œâ”€â”€ operations/page.tsx   # Pricing, Duration, & Schedule CRUD
â”‚   â”‚   â””â”€â”€ reputation/page.tsx   # Review Triage & AI Theme Dashboard
â”œâ”€â”€ get-my-card/              
â”‚   â”‚   â”œâ”€â”€ page.tsx              # Multimodal Intake + Upsell
â”‚   â”‚   â””â”€â”€ success/page.tsx      
â”œâ”€â”€ feedback/
â”‚   â”‚   â””â”€â”€ [appointmentId]/page.tsx # The Smart Review Gate
â”œâ”€â”€ api/                      
â”‚       â”œâ”€â”€ cron/retention/route.ts 
â”‚       â”œâ”€â”€ intake/parse/route.ts 
â”‚       â”œâ”€â”€ metrics/route.ts      
â”‚       â”œâ”€â”€ feedback/process/route.ts # AI Theme Extraction
â”‚       â””â”€â”€ plivo/webhook/call/route.ts 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ prisma.ts, auth.ts, square.ts, plivo.ts, vertex.ts                 
â””â”€â”€ prisma/
    â”œâ”€â”€ schema.prisma, seed.ts

--------------------------------------------------------------------------------
6. CORE ARCHITECTURAL RULES (ZERO HARDCODING)
1. Dynamic Operations: You are strictly forbidden from hardcoding service prices, appointment durations, or clinic schedules. The frontend MUST derive these values by querying the Prisma database.
2. Mobile-First UX: Design for touch. Minimum tap target size is 44px. Eliminate unnecessary clicks. The booking flow (Select Time -> Upsell -> Confirm) must be â‰¤ 3 interactions.
3. Graceful Degradation: If an external API (Square, Vertex, Plivo) fails or times out, the application MUST NOT crash. Implement try/catch blocks that return safe UI fallbacks.
4. Security Routing: Unauthenticated users accessing /admin routes must be redirected to /sign-in. BetterAuth must redirect them back to their intended destination post-login.

--------------------------------------------------------------------------------
7. THE 4 ENGINE WORKFLOWS
Engine A: The Ultra-Fast Intake Funnel (/get-my-card)
â€¢ Voice-to-JSON: Audio streamed to /api/intake/parse. Fetch active IntakeQuestions from the DB, feed to Vertex AI, and force a JSON schema output. Auto-check the UI form boxes based on the result.
â€¢ The Upsell: Interstitial modal presenting a "Driver Tune-Up" add-on. Appending this adds the dynamic DB duration to the total appointment calendar block.
â€¢ Success Routing: Instant redirect to /get-my-card/success with a green checkmark and "Return to Home" CTA.
Engine B: The Admin Operations Portal (/admin)
â€¢ Operations: CRUD for Service (pricing/duration) and ClinicSchedule (open/close hours).
â€¢ Form Builder: CRUD for the DOT medical questions evaluated by Vertex AI.
â€¢ BI Dashboard: Fetch last 30 days AOV via Square API. Calculate: 4-Week Retention Baseline, Missed Revenue, and 2/4/6 Week Revenue Projections.
Engine C: The 3-Phase Retention Engine
â€¢ Admin Config: Define 3 SMS trigger intervals (e.g., 60, 30, 7 days) and text templates (supporting {FirstName} and {attachmentUrl}).
â€¢ The Cron Worker (/api/cron/retention): Authenticate via CRON_SECRET. Query due users. Dispatch SMS via Plivo. Log to RetentionLog. Prevent duplicate sends in the same phase.
Engine D: The Reputation Engine
â€¢ Smart Gate (/feedback/[id]): 5-star clicks trigger confetti and instant redirect to the clinic's Google Maps review URL.
â€¢ Kaizen Loop: <5-star clicks open a text area. Submit internally to /api/feedback/process. Vertex AI analyzes the text, extracts a "Root Cause Theme" (e.g., "Wait Time"), and surfaces it on /admin/reputation. Do NOT redirect to Google.

--------------------------------------------------------------------------------
8. TELEPHONY REQUIREMENTS (PLIVO)
â€¢ Voice Webhook (/api/plivo/webhook/call): Plivo forwards calls from PLIVO_PROXY_NUMBER to DR_BEN_CELL_NUMBER. If status is "busy", "no-answer", or "canceled", the webhook MUST automatically dispatch an SMS back to the caller's CallerID: "I'm with a client, call you ASAP when we are finished in about 15 minutes or less!"

--------------------------------------------------------------------------------
9. PRISMA SCHEMA & SEEDING DIRECTIVES
â€¢ Models Required: IntakeQuestion, Clinic, ClinicSchedule, Service, User, Appointment, CampaignSettings, RetentionLog, Review (with aiTheme column).
â€¢ Seeding (prisma/seed.ts): Must be idempotent (upsert). Seed Weatherford TX (Active), SLC UT (Fall 2026), Standard 9-5 Schedule, DOT Physical (130,30m),Tuneâˆ’Up(100, 15m), 5 Medical Questions, and 3 mock 5-star reviews flagged isFeatured: true.

--------------------------------------------------------------------------------
10. QUALITY ASSURANCE (POKA-YOKE VALIDATION SCENARIOS)
Your code MUST pass these strict tests. If any fail during the PDCA check cycle, your implementation is rejected.
Segment A: Success & Core Workflow
â€¢ Dynamic Multimodal AI: Admin adds jsonKey: "hasSleepApnea"; /api/intake/parse MUST instruct Vertex AI to include "hasSleepApnea": boolean in JSON output.
â€¢ Single Calendar Upsell: Base service (30m) + upsell (15m) MUST equal a single 45-minute calendar block.
â€¢ Campaign Variable Parsing: Cron MUST swap {FirstName} before sending Plivo SMS.
â€¢ Square BI Accuracy: If Square AOV is $135, and 10 users are due in 2 weeks with a 50% historical retention rate, 2-week projection MUST output $675.
â€¢ AI Theme Extraction: A 2-star review reading "Doctor was 30 mins late" MUST be processed by Vertex AI, assigned a theme like "Wait Time", and saved to the DB without hitting Google.
Segment B: Expected Error Handling (Resilience)
â€¢ Telephony Fallback: If Dr. Ben rejects the call, Plivo webhook MUST catch 'busy' status and dispatch the auto-SMS to the caller.
â€¢ Voice Parsing Fallback: If Vertex AI returns { "confidence": "low" }, display a toast ("Could not hear clearly") and leave boxes blank. Do not crash.
â€¢ Square API Outage: If Square returns 500, /admin MUST fallback to calculating AOV using Prisma Service prices.
â€¢ Double-Booking Rejection: Simultaneous booking attempts for the same slot MUST result in 409 Conflict for the second user.
â€¢ Unauthenticated Cron Access: /api/cron/retention without CRON_SECRET MUST return 401 Unauthorized.
Segment C: Low-Friction UX & Navigation
â€¢ The 3-Click Checkout: From Time Select -> Upsell -> Confirm MUST be â‰¤ 3 interactions.
â€¢ Instant Visual Confirmation: Successful booking MUST instantly route to /get-my-card/success with a green checkmark and "Return to Home" CTA.
â€¢ Review Gate UX: A 5-star click on /feedback MUST bypass text entry, show confetti, and redirect immediately to the external Google Review URL.
â€¢ Dead-End Avoidance: Unauthenticated users hitting /admin MUST route to /sign-in. Upon login, BetterAuth MUST redirect them to their intended /admin destination.
â€¢ Ticker Tape UX: The 5-star review ticker MUST auto-play using CSS keyframes/Framer Motion to continuously animate horizontally upon page load without user interaction.
â€¢ Franchise UX: Navigating to SLC location MUST display "Opening Fall 2026", completely disable the booking calendar, and hide the intake form.
Segment D: Database Integrity
â€¢ Idempotent Seeding: npx prisma db seed run 3 times MUST NOT create duplicate clinics or services.
â€¢ Retention Math: nextDueDate MUST correctly calculate exactly 2 years from scheduledFor.
â€¢ Cascade Deletion: Deleting a User MUST cascade to delete associated Appointment, Review, and RetentionLog records.

--------------------------------------------------------------------------------

11. QUOTA CONSERVATION & MODEL-SWITCHING PROTOCOL
You must act as a resource-aware agent. Before initiating a task, categorize its complexity and suggest the appropriate model to the user:

* **SWITCH TO GEMINI 3.1 PRO (High Thinking) FOR:**
    * Initial project scaffolding and complex Prisma schema migrations.
    * Architecting the Plivo Voice Webhook logic and multi-step redirection.
    * Building the Revenue Projection math and Square BI logic.
    * Root-cause analysis of critical build failures or logic loops.

* **SWITCH TO GEMINI 3.1 FLASH (Fast Mode) FOR:**
    * Generating boilerplate UI components (Buttons, Inputs, Tickers).
    * Writing documentation, READMEs, or SMS message templates.
    * Standard CSS/Tailwind styling adjustments.
    * Simple CRUD operations or basic unit tests.

* **TASK SEGMENTATION:** If a task involves both architecture and styling, decompose the task. Perform the architecture in Pro, then instruct the user to swap to Flash for the styling phase.