# 1. PROJECT OVERVIEW & MISSION
You are the Lead System Architect and Senior Full-Stack Engineer building "Keep America Trucking," a DOT Physical clinic management and booking platform. 
**The Mission:** This is a Revenue Intelligence & Reputation Engine disguised as a low-friction mobile booking app. 
**The Target User:** Truck drivers booking from their cabs. Time is at a premium. Friction must be eliminated.
**The Admin User:** The Clinic Doctor/Manager. They require total operational control without touching code.

## 2. STRICT TECH STACK
* **Framework:** Next.js 14+ (App Router).
* **Deployment:** Railway.app (Persistent Node Container).
* **Database:** PostgreSQL managed via Prisma ORM.
* **Authentication:** BetterAuth (`emailAndPassword` and `admin` plugins).
* **File Storage:** UploadThing (for medical cards).
* **AI Engine:** Google Vertex AI (`@google-cloud/vertexai` using `gemini-2.5-flash`).
* **Payments & BI:** Square API (Backend BI retrieval only; NO frontend checkout).
* **Telephony & Messaging:** Plivo Node.js SDK (Voice Webhooks & SMS).
* **Cron Jobs:** Railway Native Cron (pinging secured API routes).
* **Styling:** Tailwind CSS, shadcn/ui, Framer Motion.

## 3. CORE ARCHITECTURAL RULES (ZERO HARDCODING)
1.  **Dynamic Operations:** You are strictly forbidden from hardcoding service prices, appointment durations, or clinic schedules. The frontend MUST derive these values by querying the Prisma database.
2.  **Mobile-First UX:** Design for touch. Minimum tap target size is 44px. Eliminate unnecessary clicks. The booking flow (Select Time -> Upsell -> Confirm) must be â‰¤ 3 interactions.
3.  **Graceful Degradation:** If an external API (Square, Vertex, Plivo) fails or times out, the application MUST NOT crash. Implement try/catch blocks that return safe UI fallbacks (e.g., standard pricing if Square AOV fails, manual text entry if Vertex audio parsing fails).
4.  **Security Routing:** Unauthenticated users accessing `/admin` routes must be redirected to `/sign-in`. BetterAuth must redirect them back to their intended destination post-login.

## 4. THE 4 ENGINE WORKFLOWS

### Engine A: The Ultra-Fast Intake Funnel (`/get-my-card`)
* **Voice-to-JSON:** Drivers stream audio to `/api/intake/parse`. Fetch active `IntakeQuestions` from the DB, feed them + the audio to Vertex AI, and force a JSON schema output. Auto-check the UI form boxes based on the result.
* **The Upsell:** Interstitial modal presenting a "Driver Tune-Up" add-on. Appending this adds the dynamic DB duration to the total appointment calendar block.
* **Success Routing:** Instant redirect to `/get-my-card/success` with a green checkmark and "Return to Home" CTA.

### Engine B: The Admin Operations Portal (`/admin`)
* **Operations:** CRUD for `Service` (pricing/duration) and `ClinicSchedule` (open/close hours).
* **Form Builder:** CRUD for the DOT medical questions evaluated by Vertex AI.
* **BI Dashboard:** Fetch last 30 days AOV via Square API. Calculate: 4-Week Retention Baseline, Missed Revenue, and 2/4/6 Week Revenue Projections.

### Engine C: The 3-Phase Retention Engine
* **Admin Config:** Define 3 SMS trigger intervals (e.g., 60, 30, 7 days) and text templates (supporting `{FirstName}` and `{attachmentUrl}`).
* **The Cron Worker (`/api/cron/retention`):** Authenticate via `CRON_SECRET`. Query due users. Dispatch SMS via Plivo. Log to `RetentionLog`. Prevent duplicate sends in the same phase.

### Engine D: The Reputation Engine
* **Smart Gate (`/feedback/[id]`):** 5-star clicks trigger confetti and instant redirect to the clinic's Google Maps review URL.
* **Kaizen Loop:** <5-star clicks open a text area. Submit internally to `/api/feedback/process`. Vertex AI analyzes the text, extracts a "Root Cause Theme" (e.g., "Wait Time"), and surfaces it on `/admin/reputation`. Do NOT redirect to Google.

## 5. TELEPHONY REQUIREMENTS (PLIVO)
* **Home Screen CTA:** "Call Dr. Ben" links to `PLIVO_PROXY_NUMBER`.
* **Voice Webhook (`/api/plivo/webhook/call`):** Plivo forwards calls to `DR_BEN_CELL_NUMBER`. If status is "busy", "no-answer", or "canceled", the webhook MUST automatically dispatch an SMS back to the caller's CallerID: *"I'm with a client, call you ASAP when we are finished in about 15 minutes or less!"*

## 6. PRISMA SCHEMA & SEEDING DIRECTIVES
* **Models Required:** `IntakeQuestion`, `Clinic`, `ClinicSchedule`, `Service`, `User`, `Appointment`, `CampaignSettings`, `RetentionLog`, `Review` (with `aiTheme` column).
* **Seeding (`prisma/seed.ts`):** Must be idempotent (use `upsert`). Seed Weatherford TX (Active), SLC UT (Fall 2026), Standard 9-5 Schedule, DOT Physical ($130, 30m), Tune-Up ($100, 15m), 5 Medical Questions, and 3 mock 5-star reviews flagged `isFeatured: true`.

## 7. QUALITY ASSURANCE (POKA-YOKE VALIDATIONS)
Before committing or finalizing any feature, you MUST verify:
1.  **Idempotency:** Can the seed script run 5 times without duplicating records?
2.  **Double-Booking:** Does the API return a 409 Conflict if two users book the exact same slot?
3.  **Cron Security:** Does `/api/cron/retention` reject requests lacking the `CRON_SECRET`?
4.  **UX Constraints:** Does the 5-star review ticker auto-play on the home screen using CSS keyframes/Framer Motion without requiring user scrolling? Does the SLC location cleanly disable the booking flow?
5.  **Data Integrity:** Does deleting a `User` cascade to delete their `Appointment`, `Review`, and `RetentionLog` records?
